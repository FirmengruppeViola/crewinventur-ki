require "base64"

default_platform(:ios)

platform :ios do
  def scrub_empty_env(*keys)
    keys.each do |key|
      ENV.delete(key) if ENV[key].to_s.strip.empty?
    end
  end

  def ensure_match_config!
    scrub_empty_env("MATCH_GIT_PRIVATE_KEY", "MATCH_GIT_BASIC_AUTHORIZATION", "MATCH_GIT_URL")
    UI.user_error!("MATCH_GIT_URL fehlt. Bitte Secret setzen.") unless ENV["MATCH_GIT_URL"]
  end

  def app_identifier
    ENV["APP_IDENTIFIER"] || "de.firmengruppeviola.crewinventur"
  end

  def app_store_api_key
    raw_key = ENV.fetch("APP_STORE_CONNECT_KEY")
    key_content = raw_key.gsub("\\n", "\n").gsub("\r", "").strip
    decoded_key = if key_content.match?(/BEGIN (EC )?PRIVATE KEY/)
                    key_content
                  else
                    Base64.decode64(key_content).gsub("\r", "").strip
                  end

    app_store_connect_api_key(
      key_id: ENV.fetch("APP_STORE_CONNECT_KEY_ID"),
      issuer_id: ENV.fetch("APP_STORE_CONNECT_ISSUER_ID"),
      key_content: decoded_key,
      is_key_content_base64: false,
    )
  end

  def ensure_build_number
    build_number = ENV["BUILD_NUMBER"] || ENV["GITHUB_RUN_NUMBER"]
    return unless build_number

    increment_build_number(
      xcodeproj: "App/App.xcodeproj",
      build_number: build_number,
    )
  end

  def configure_code_signing(team_id)
    profile_mapping = lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING] || {}
    profile_name = profile_mapping[app_identifier]
    UI.user_error!("Kein Provisioning-Profil fÃ¼r #{app_identifier} gefunden.") if profile_name.to_s.strip.empty?

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "App/App.xcodeproj",
      team_id: team_id,
      code_sign_identity: "Apple Distribution",
      profile_name: profile_name,
      targets: ["App"],
      build_configurations: ["Release"],
    )

    {
      signingStyle: "manual",
      provisioningProfiles: {
        app_identifier => profile_name,
      },
    }
  end

  def build_ios_app
    team_id = ENV["APPLE_TEAM_ID"].to_s.strip
    UI.user_error!("APPLE_TEAM_ID fehlt. Bitte Secret setzen.") if team_id.empty?

    update_project_team(
      path: "App/App.xcodeproj",
      teamid: team_id,
    )

    export_options = configure_code_signing(team_id)

    build_app(
      project: "App/App.xcodeproj",
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      export_team_id: team_id,
      export_options: export_options,
      clean: true,
      output_directory: "../build",
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    setup_ci
    api_key = app_store_api_key

    ensure_match_config!
    match(
      readonly: false,
      git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"],
    )

    ensure_build_number
    build_ios_app

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
    )
  end

  desc "Build and upload to App Store Connect"
  lane :release do
    setup_ci
    api_key = app_store_api_key

    ensure_match_config!
    match(
      readonly: false,
      git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"],
    )

    ensure_build_number
    build_ios_app

    upload_to_app_store(
      api_key: api_key,
      skip_metadata: true,
      skip_screenshots: true,
      force: true,
    )
  end
end
